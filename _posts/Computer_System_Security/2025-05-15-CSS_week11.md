---
layout: post
title: "[컴퓨터시스템보안] 11주차 - 버퍼 오버플로우"
excerpt: "스택 버퍼 오버플로우, 쉘 코드, 버퍼 오버플로우 방어, 다른 형태의 오버플로우 공격"

tags:
  - [컴퓨터시스템보안]

toc: true

date: 2025-05-15
last_modified_at: 2025-05-15
---
## 버퍼 오버플로우
- 매우 일반적인 공격 메커니즘
  - 1988년 **모리스 인터넷 웜**에 의해 처음 사용됨
  - CERT나 SANS의 경고 리스트에 많이 포함

- 예방 기법이 비교적 잘 알려져 있고 문서화되어 있음

- 아직까지도 보안에서 중요한 관심 사항
  - 기존 코드에서 여전히 발견됨
  - 프로그래머의 **부주의한 프로그래밍 습관**의 지속

<br>

### 1. 스택 버퍼 오버플로우  
- **버퍼 오버플로우**(buffer overflow)
  - 버퍼 오버런(buffer overrun) or 버퍼 오버라이트(buffer overwrite)라고도 함
  - 정의 : 데이터 저장 섹션에 **할당된 용량보다 더 많은 자료를 입력**하여 **다른 정보를 변경**할 수 있는 인터페이스에서의 조건(취약점).  
  공격자는 이런 취약점을 이용하여 **시스템을 손상**시키거나 시스템을 제어할 수 있는 **특수하게 조작된 코드를 삽입**  

<br>

- 하나의 프로세스가 **고정된 크기의 버퍼 용량**을 초과하는 데이터를 저장하려 할 때의 **프로그래밍 에러**
- **인접 메모리 공간**을 덮어씀
  - 인접 공간에는 다른 변수나 **복귀 주소**, **프로그램 카운터** 등이 저장되어 있을 수 있음
  - 아래는 함수 `P`가 함수 `Q`를 호출하는 예시  
  ![function_call][def]  
- 버퍼는 **스택(stack)**이나 **힙(heap)** 또는 프로세스의 **데이터 섹션**에 위치  
  - 프로그램과 프로세스  
  ![program_process][def2]  

- 결과
  - 프로그램 데이터의 손상
  - 예상치 못한 제어 전환
  - 메모리 접근 위반 (segmentation fault)
  - 공격자에 의해 선택된 코드 실행  

<br>

- Basic buffer overflow C code  
![basic_buffer_overflow_code][def6]  
- Basic buffer overflow example runs  
![basic_buffer_overflow_example_runs][def7]  
- Basic buffer overflow stack values  
![basic_buffer_overflow_stack_values][def8]  

<br>

- 공격자가 버퍼 오버플로우를 이용하려면 다음 작업이 필요
  - 프로그램의 **버퍼 오버플로우 취약점** 탐색
  - 메모리 저장 방식을 이해햐여 **인접 메모리 영역 손상 가능성**과 **프로그램 실행 제어 변경 가능성** 탐색

- 취약한 프로그램 식별 방식
  - 프로그램 소스 직접 분석/검사
  - 초과된 용량의 임력을 사용하여 프로그램 실행 추적
  - 프로그램의 취약점을 자동으로 찾아주는 **퍼징(fuzzing)**과 같은 도구 사용  

<br>

- 프로그래밍 언어
   - 기계 수준에서 프로세서에 의해 실행되는 **기계어**가 처리하는 모든 데이터는 **프로세서의 레지스터**나 **메모리**에 저장됨  
   - 레지스터나 메모리에 저장된 데이터 값에 대한 정확한 책임은 **어셈블리 언어 프로그래머**에게 있음.

<br>

- 함수의 지역 변수처럼 **공격 대상 버퍼가 스택**에 있을 때 발생
  - 일부 라이브러리 함수에서 **버퍼 오버플로우 여부를 검사하지 않음을 이용
  

- 함수 호출 메커니즘: 스택 프레임 사용
  - 하나의 함수가 다른 함수를 호출할 때, **복귀 주소**를 저장할 장소가 필요.  
  전달할 인수를 저장할 장소와, 호출하기 전에 사용한 레지스터 값 또한 보관 필요
  - 이들은 **스택 프레임**에 저장됨
  - 현재의 고급 언어들은 대부분의 **지역 변수**도 함수의 스택 프레임에 저장

<br>

- Basic Stack Overflow Example  
![basic_stack_overflow_example][def3]  
- Basic Stack Overflow Stack Values  
![basic_stack_overflow_stack_values][def4]  
- Another Stack Overflow Example  
![another_stack_overflow_example][def5]  

<br>

- 많이 사용되는 안전하지 않은 C 표준 라이브러리 루틴들

|라이브러리 함수|설명|
|---|---|
|`gets(char* str)`|표준 입력으로부터 `str`로 한 줄을 입력|
|`sprintf(char* str, char* format, ...)`|명시된 형식과 변수에 따라 `str`을 구성|
|`strcat(char* dest, char* src)`|문자열 `src`의 내용을 문자열 `dest`에 붙임|
|`strcpy(char* dest, char* src)`|문자열 `src`의 내용을 문자열 `dest`에 복사|
|`vsprintf(char* str, char* fmt, va_list ap)`|명시된 형식과 변수에 따라 `str`을 구성|  

<br>

### 2. 쉘 코드(Shellcode)
- 공격자가 작성하여 제공한 코드
  - 보통 **오버플로우가 발생한 버퍼**에 저장됨
  - command line interpreter인 **shell**로 제어를 넘기고,  
  공격당한 프로그램의 권한으로 시스템의 다른 프로그램에 접근
    - Unix에서는 `execve("/bni/sh")` 시스템 함수를 호출하는 코드를 컴파일
    - Windows에서는 `system("command.exe")` 함수를 호출하여 DOS command(명령 프롬프트) 쉘을 수행

- 기계어 코드로 작성
  - 프로세스와 운영체제에 dependent
  - 공격 대상 시스템의 **어셈블리어 언어**에 대해 숙련된 기술이 요구됨
  - 최근에는 이 과정을 자동화하는 많은 사이트와 도구들이 존재

<br>

### 3. 버퍼 오버플로우 방어

<br>

### 4. 다른 형태의 오버플로우 공격

<br>
<br>
<br>
<br>
<details>
<summary>주의사항</summary>
<div markdown="1">

이 포스팅은 강원대학교 이헌길 교수님의 컴퓨터시스템보안 수업을 들으며 내용을 정리 한 것입니다.  
수업 내용에 대한 저작권은 교수님께 있으니,  
다른 곳으로의 무분별한 내용 복사를 자제해 주세요.

</div>
</details>

[def]: https://i.imgur.com/qzKdDgQ.png
[def2]: https://i.imgur.com/4SLAEST.png
[def3]: https://i.imgur.com/t3xTtka.png
[def4]: https://i.imgur.com/yS5DYM9.png
[def5]: https://i.imgur.com/jj4d4RG.png
[def6]: https://i.imgur.com/o2tt3YC.png
[def7]: https://i.imgur.com/XUZpPvH.png
[def8]: https://i.imgur.com/drvwo9k.png