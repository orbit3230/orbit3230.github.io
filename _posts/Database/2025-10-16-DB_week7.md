---
layout: post
title: "[데이터베이스] 7주차 - 데이터베이스 프로그래밍"
excerpt: "데이터베이스 프로그래밍 방법, PL/SQL, 데이터베이스 연동 자바 프로그래밍"

tags:
  - [데이터베이스]

toc: true

date: 2025-10-16
last_modified_at: 2025-10-20
---
## 데이터베이스 프로그래밍
### 1. 데이터베이스 프로그래밍 방법
- 데이터베이스 프로그래밍
  - DBMS에 데이터를 정의하고 저장된 데이터를 읽어와 데이터를 변경하는 프로그램을 작성하는 과정
  - 일반 프로그래밍과는 데이터베이스 언어인 SQL을 포함한다는 점이 다름  
  ![db_programming][def]  

  <br>

- 데이터베이스 프로그래밍 방법  
  - (1) SQL 전용 언어를 사용하는 방법
    - SQL 자체의 기능을 확장하여 변수, 제어, 입출력 등의 기능을 추가한 새로운 언어를 사용하는 바업ㅂ.
    - Oracle은 PL/SQL 언어를 사용하며, SQL Server는 T-SQL 언어를 사용  

  - (2) 일반 프로그래밍 언어에 SQL을 삽입하여 사용하는 방법 (Embedded SQL)
    - Java, C, C++ 등 일반 프로그래밍 언어에 SQL을 삽입하여  사용하는 방법
    - 일반 프로그래밍 언어로 작성된 응용 프로그램에서 데이터베이스에 저장된 데이터를 관리, 검색
    - 삽입된 SQL문은 DBMS의 컴파일러가 처리

  - (3) 웹 프로그래밍 언어에 SQL을 삽입하여 사용하는 방법 <- 가장 많이 사용
    - 호스트 언어가 JSP, ASP, PHP 등 웹 스크립트 언어인 경우  

  - (4) 4GL (4th Generation Language)
    - 데이터베이스 관리 기능과 비주얼 프로그래밍 기능을 갖춘 'GUI 기반 소프트웨어 개발 도구'를 사용하여 프로그래밍하는 방법. Delphi, PowerBuilder, Visual Basic 등

  - (5) Mobile Application  

- Visualization  
![db_programming_methods][def2]  

<br>

### 2. PL/SQL
- Procedual Language/Structured Query Language

- 데이터베이스 응용프로그램을 작성하는 데 사용하는 오라클의 SQL 전용 언어.

- SQL 전용 언어로 SQL 문에 변수, 제어, 입출력 등의 프로그래밍 기능을 추가하여 SQL 만으로 처리하기 어려운 문제를 해결

- PL/SQL은 SQL Developer에서 바로 작성하고 컴파일한 후 결과를 실행  
![pl_sql][def3]  

<br>

- 프로시저  
![procedure][def4]  
  - 프로시저를 정의하려면 `CREATE PROCEDURE` 문을 사용  
  - 정의 방법  
    - 선언부와 실행부(BEGIN ... END)로 구성  
    - 선언부에서는 변수와 매개변수를 선언, 실행부에서는 프로그램 로직을 구현
    - 매개변수(parameter)는 저장 프로시저가 호출될 때 그 프로시저에 전달되는 값
    - 변수(variable)는 저장 프로시저나 트리거 내에서 사용되는 값
    - 주석은 `/*`와 `*/` 사이에 작성하거나 `--` 뒤에 작성  

<br>

- 삽입 작업을 하는 프로시저

```sql
CREATE OR REPLACE PROCEDURE InsertBook (
    myBookID IN NUMBER,
    myBookName IN VARCHAR2,
    myPublisher IN VARCHAR2,
    myPrice IN NUMBER
)
AS
BEGIN
    INSERT INTO Book (BookID, BookName, Publisher, Price)
        VALUES (myBookID, myBookName, myPublisher, myPrice);
END;
```

```sql
-- 프로시저 호출
EXEC InsertBook(7, 'Florian Wirtz', 'Liverpool', 30000);
```

<br>

- 제어문을 사용하는 프로시저

```sql
CREATE OR REPLACE PROCEDURE BookInsertOrUpdate (
    myBookID IN NUMBER,
    myBookName IN VARCHAR2,
    myPublisher IN VARCHAR2,
    myPrice INT
)
AS
    mycount NUMBER;
BEGIN
    SELECT COUNT(*) INTO mycount
        FROM Book
        WHERE bookname LIKE myBookName;
    IF mycount != 0 THEN
        UPDATE Book SET price = myPrice
        WHERE bookname LIKE myBookName;
    ELSE
        INSERT INTO Book(bookid, bookname, publisher, price)
            VALUES (myBookID, myBookName, myPublisher, myPrice);
    END IF;
END;
```

- 결과를 반환하는 프로시저
  - `Book` 테이블에 저장된 도서의 평균 가격을 반환하는 프로시저(`AveragePrice`)  

```sql
CREATE OR REPLACE PROCEDURE AveragePrice (
    AverageVal Out NUMBER
)
AS
BEGIN
    SELECT AVG(Price) INTO AverageVal FROM Book WHERE price IS NOT NULL;
END;
```

```sql
-- 프로시저 호출
SET SERVEROUTPUT ON;
DECLARE
    AverageVal NUMBER;
BEGIN
    AveragePrice(AverageVal);
    DBMS_OUTPUT.PUT_LINE('Average Price: ' || AverageVal);
END;
```

<br>

- 커서를 반환하는 프로시저
  - 커서와 관련된 키워드  

  |키워드|역할|
  |---|---|
  |`CURSOR <커서 이름> IS <커서 정의>`|커서를 생성|
  |`OPEN <커서 이름>`|커서의 사용을 시작|
  |`FETCH <커서 이름> INTO <변수>`|행 데이터를 가져옴|
  |`CLOSE <커서 이름>`|커서의 사용을 종료|

  - `Orders` 테이블의 판매 도서에 대한 이익을 계산하는 프로시저(`Interest`)  

```sql
CREATE OR REPLACE PROCEDURE Interest
AS
    myInterest NUMERIC;
    Price NUMERIC;
    CURSOR InterestCursor IS SELECT saleprice FROM Orders;
BEGIN
    myInterest := 0;  -- 대입 연산자 :=
    OPEN InterestCursor;
    LOOP
        FETCH InterestCursor INTO Price;
        EXIT WHEN InterestCursor%NOTFOUND;
        IF Price >= 30000 THEN
            myInterest := myInterest + Price * 0.1;
        ELSE
            myInterest := myInterest + Price * 0.05;
        END IF;
    END LOOP;
    CLOSE InterestCursor;
    DBMS_OUTPUT.PUT_LINE('Total Interest: ' || myInterest);
END;
```

```sql
-- 프로시저 호출
SET SERVEROUTPUT ON;
EXEC Interest;
```

<br>

- 트리거(trigger) : 데이터의 변경(삽입, 삭제, 갱신)문이 실행될 때 자동으로 따라서 실행되는 프로시저.  
![trigger][def11]  

<br>

- 새로운 도서를 삽입한 후 자동으로 `Book_log` 테이블에 삽입한 내용을 기록하는 트리거  
  - 테이블 생성

```sql
CREATE TABLE Book_log (
  bookid_l NUMBER,
  bookname_l VARCHAR2(40),
  publisher_l VARCHAR2(40),
  price_l NUMBER,
);
```

  - 트리거 생성

```sql
/* 파일명 : AfterInsertBook.sql */
CREATE OR REPLACE TRIGGER AfterInsertBook
```

```sql
AFTER INSERT ON Book FOR EACH ROW
DECLARE
  average NUMBER;
BEGIN
  INSERT INTO Book_log
    VALUES (:new.bookid, :new.bookname, :new.publisher, :new.price);
  DBMS_OUTPUT.PUT_LINE('Backup insert tuple into Book_log table');  
END;
```

```sql
-- 트리거 테스트
INSERT INTO Book VALUES(7, 'Florian Wirtz', 'Liverpool', 30000);
```

<br>

- 사용자 정의 함수(user-defined function)  

- 판매된 도서에 대한 이익을 계산하는 함수(`fnc_Interest`)  

```sql
CREATE OR REPLACE FUNCTION fnc_Interest (
  Price NUMBER
) RETURN INT
IS
  myInterest NUMBER;
BEGIN
/* 가격이 30000 이상이면 10%, 미만이면 5% */
  IF Price >= 30000 THEN
    myInterest := Price * 0.1;
  ELSE
    myInterest := Price * 0.05;
  END IF;
  RETURN myInterest;
END;
```

<br>

- 프로시저, 트리거, 사용자 정의 함수의 공통점과 차이점  
![db_programming_comparison][def5]  

<br>

- PL/SQL 문법 요약

|구분|명령어|
|---|---|
|데이터 정의어|`CREATE TABLE`<br>`CREATE PROCEDURE`<br>`CREATE FUNCTION`<br>`CREATE TRIGGER`<br>`ALTER`, `DROP`|
|데이터 조작어|`SELECT`<br>`INSERT`<br>`DELETE`<br>`UPDATE`|
|변수|`DECLARE` 문으로 선언<br>치환(`:=` 사용)|
|연산자|산술 연산자(`+`, `-`, `*`, `/`)<br>비교 연산자(`=`, `<>`, `<`, `>`, `<=`, `>=`)<br>문자열 연산자(`ll`)<br>논리 연산자(`AND`, `OR`, `NOT`)|
|주석|`--`, `/* ... */`|
|내장 함수|숫자함수(`ABS`, `CEIL`, `FLOOR`, `POWER` 등)<br>집계 함수(`AVG`, `COUNT`, `MAX`, `MIN`, `SUM` 등)<br>날짜 함수(`SYSDATE`, `NEXT_DAY`, `TO_CHAR` 등)<br>문자열 함수(`CHR`, `LENGTH`, `LOWER`, `SUBSTR` 등)|
|제어문|`BEGIN ... END`<br>`IF ... THEN ... ELSE ... END IF`<br>`FOR LOOP ... END LOOP`<br>`WHILE LOOP ... END LOOP`<br>`EXIT`|
|데이터 제어어|`GRANT`<br>`REVOKE`|  

<br>

### 3. 데이터베이스 연동 자바 프로그래밍
- 데이터베이스 연동 Java 프로그래밍 실습 환경

|항목|프로그램|
|---|---|
|항목|프로그램|
|데이터베이스 프로그램|오라클 데이터베이스 18c XE|
|Java 컴파일러|JDK 버전 8 이상|
|데이터베이스와 Java를 연결하는 드라이버|Oracle JDBC Driver (ojdbc8.jar)|

<br>

- 데이터베이스 접속 Java 클래스  
![db_java_class][def6]  

- 자바 프로그램의 데이터베이스 연동  
![db_java_connection][def7]  

- 객체 간의 호출 순서  
![db_java_call_sequence][def8]  

- 데이터베이스 연동 Java 프로그램의 실행 흐름도  
![db_java_flowchart][def9]  

- 데이터베이스 연동 Java 프로그램 예제

```java
import java.io.*;
import java.sql.*;
import java.sql.CallableStatement;

public class booklist {
  Connection con;

  public booklist() {
    String url = "jdbc:oracle:thin:@localhost:1521:xe";
    String userid = "c##madang";  // 12버전 이상은 c## prefix 필요
    String pwd = "madang";

    try {  // 드라이버를 찾는 과정
      Class.forName("oracle.jdbc.driver.OracleDriver");
      System.out.println("Driver loading success.");
    }
    catch(ClassNotFoundException e) {
      e.printStackTrace();
    }

    try {  // 데이터베이스에 접속하는 과정
      System.out.println("Connecting to the database...");
      con = DriverManager.getConnection(url, userid, pwd);
      System.out.println("Connection success.");
    }
    catch(SQLException e) {
      e.printStackTrace();
    }

    private void sqlRun() {
      String query = "SELECT * FROM Book";  // SQL문
      try {  // 데이터베이스에 query 결과를 가져오는 과정
        Statement stmt = con.createStatement();
        ResultSet rs = stmt.executeQuery(query);
        System.out.println("BOOK NO \t Book NAME \t\t PUBLISHER \t PRICE");
        while(rs.next()) {
          Systemout.print("\t" + rs.getInt(1));  // BookID
          Systemout.print("\t" + rs.getString(2));  // BookName
          Systemout.print("\t\t" + rs.getString(3));  // Publisher
          Systemout.println("\t" + rs.getInt(4));  // Price
        }
        con.close();
      }
      catch(SQLException e) {
        e.printStackTrace();
      }
    }
    public static void main(String[] args) {
      booklist app = new booklist();
      app.sqlRun();
    }
  }
}
```

- 데이터베이스 연동 Java 프로그램 실행 결과  
![db_java_output][def10]  


<br>
<br>
<br>
<br>
<details>
<summary>주의사항</summary>
<div markdown="1">

이 포스팅은 강원대학교 최황규 교수님의 데이터베이스 수업을 들으며 내용을 정리 한 것입니다.  
수업 내용에 대한 저작권은 교수님께 있으니,  
다른 곳으로의 무분별한 내용 복사를 자제해 주세요.

</div>
</details>

[def]: https://i.imgur.com/E0gmoLR.png
[def2]: https://i.imgur.com/0cpJ38i.png
[def3]: https://i.imgur.com/5FQtSlG.png
[def4]: https://i.imgur.com/e3owTKP.png
[def5]: https://i.imgur.com/iSa3Zua.png
[def6]: https://i.imgur.com/XsGEKmt.png
[def7]: https://i.imgur.com/aG7zscX.png
[def8]: https://i.imgur.com/TgGkqIs.png
[def9]: https://i.imgur.com/gRQdZqj.png
[def10]: https://i.imgur.com/dRgmdmn.png
[def11]: https://i.imgur.com/FNIq11F.png