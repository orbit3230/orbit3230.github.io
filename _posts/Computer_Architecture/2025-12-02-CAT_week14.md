---
layout: post
title: "[컴퓨터구조] 14주차 - MIPS Pipelining"
excerpt: "Advantages of Microprogramming, Update of Machine Behavior, New Attack Surfaces on ISA/uArch/uCode, Basic Idea of Pipelining, An Ideal Pipeline, Pipelined Operation, Pipeline Design"

tags:
  - [컴퓨터구조]

toc: true

date: 2025-12-02
last_modified_at: 2025-12-03
---
## MIPS Microarchitecture
### 1. Advantages of Microprogramming
- The Power of Abstraction
  - Microinstructions의 control store 개념은 하드웨어 디자이너가, **microprogramming**이라는 새로운 추상화를 가능하게 한다.
  - 디자이너는 어떠한 operation이든 microinstructions의 시퀀스로 구현할 수 있다.
  - 모든 디자이너가 제공해야 할 것은,
    - 원하는 operation을 구현하는데 필요한 microinstruction 시퀀스
    - microinstruction을 통해 control logic이 올바르게 sequence되도록 보장하는 것
    - 필요한 어떠한 추가적인 datapath elements와 control signals

- Microprogrammed Control의 장점  
  - 아주 간단한 디자인으로 하여금 datapath를 컨트로함으로써 강력한 computation을 가능하게 한다.
    - High-level ISA가 microcode로 번역된다. (u-instructions의 시퀀스)
    - Microcode(u-code)는 minimal datapath가 ISA를 emulate하도록 해준다.
    - Microinstructions는 user-invisible ISA(u-ISA)로 생각될 수도 있다.

  - ISA의 쉬운 확장가능성을 제공한다.
    - microcode를 변경하는 것만으로도 새로운 명령어를 지원할 수 있다.
    - 복잡한 명령어들을 간단한 microinstructions의 시퀀스로 지원할 수 있다.

  - Machine behavior의 업데이트를 가능하게 한다.
    - 명령어 구현이 buggy하더라도, field에서 microcode를 변경하여 고칠 수 있다.
    - 바로 다음 섹션에서 다룬다.

    <br>

### 2. Update of Machine Behavior
- Field에서 차후에 micro code를 update/patch 가능하게 되면, 프로세서 변경 없이 새로운 명령어를 추가할 수 있게 해준다!

- Example
  - IBM 370 Model 145 : 메인 메모리에 저장된 microcode가 reboot후 업데이트 될 수 있다.
  - IBM System z : 370/145와 비슷하다.
  - B1700 microcode는 프로세서가 실행되는 동안에도 업데이트 될 수 있다.
    - User-microprogrammable machine !

  - Example of modern CPUs  
  ![modern_cpu_microcode_update][def]  

<br>

### 3. New Attack Surfaces on ISA/uArch/uCode  
- Example in terms of system security  
![microcode_security_attack_surface][def2]  

<br>

- Breaking the x86 instruction set, Blackhat 2017
- Reverse-engineering x86 Processor Microcode, Philipp Koppe et al., USENIX Security 2017
- An Exploratory Analysis of Microcode as a Building Block for System Defenses, Benjamin Kollenda et al., CCS 2018
- CHEx86: Context-Sensitive Enforcement of Memory Safety via Microcode-Enabled Capabilities, Rasool Sharifi, ISCA 2020
- On the Design and Misuse of Microcoded (Embedded) Processors - A Cautionary Note, Nils Albartus et al, USENIX Security 2021
- ...

<br>

## MIPS Pipelining
### 1. Basic Idea of Pipelining
- Can We Do Better?

- Concurrency를 향상시키기 위해 Idle Hardware를 사용할 수 있을까?
  - 목표 : **More concurrency** -> **Higher instruction throughput**  
  (즉, 한 사이클에 더 많은 "work" 수행)

  - 아이디어 : 명령어가 처리 단계에 리소스를 사용하는 동안, 해당 명령어가 필요로 하지 않는 idle 리소스로 다른 명령어를 처리
    - e.g., 명령어가 decode 되는 동안, 다음 명령어를 fetch
    - e.g., 명령어가 실행되는 동안, 다른 명령어를 decode
    - e.g., 명령어가 데이터 메모리에 접근하는 동안(ld/st), 다음 명령어를 실행
    - e.g., 명령어가 결과를 레지스터 파일에 쓰는 동안, 다음 명령어에 대한 데이터 메모리에 접근

- Pipelining: Basic Idea
  - More systematically, 여러 명령어의 실행을 Pipeline.
  - 아이디어
    - 명령어 처리 사이클을 별개의 처리 "단계(stages)"로 나눈다.
    - 물론, 각 단계에서 하나의 명령어를 처리할 수 있는 충분한 하드웨어 리소스가 필요하다.
    - 각 단계에서 서로 다른 명령어를 처리한다.
      - 프로그램 순서 상 연속된 명령어들은 연속된 stages에서 처리된다.  

  - 이점 : 명령어 처리 throughput(1/CPI)를 증가시킨다.
  - 단점 : 차후 다룬다.

<br>

- Example: Execution of Four Independent `ADD`
  - Multi-cycle : 명령어 당 `4` cycles  
  ![example_multi_cycle][def3]  

  - Pipelined : `4`개 명령어 당 `4`cycles (steady state)  
  ![example_pipelined][def4]  

- The Laundry Analogy  
![laundry_analogy][def5]  
  - 실제로는 각 단계의 실행 시간이 다르니, 가장 느린 step이 throughput을 결정한다.  
  ![laundry_pipeline_in_practice][def6]  
  - 그렇다면 가장 느린 단계를 수행하는 하드웨어를 여러 개 두면 개선할 수도 있겠다.  
  ![laundry_pipeline_with_replicas][def7]  
    - 또는 더 빠른 하드웨어를 사용한다거나...

<br>

### 2. An Ideal Pipeline
- 목표 : 최소한의 Cost 증가로 Throughput을 극대화하는 것 (명령어 처리의 경우, 하드웨어 cost)

- 동일한 operations의 반복
  - 다양한 많은 수의 inputs들에 대해 동일한 operation이 반복된다.  

- 독립적인 operations의 반복
  - 반복되는 operations 간에는 dependencies가 없어야 한다.

- 균등하게 나누어질 수 있는 sub-operations
  - 프로세싱 과정은 균등한 latency의 sub-operations으로 even하게 나누어질 수 있어야 한다.
  - sub-operations 간에는 리소스를 공유하지 않아야 한다.

- Ideal Pipelining  
![ideal_pipelining][def8]  

<br>

- More Realistic Pipeline: Cost
  - 각 stage는 latch를 필요로 한다. Latch에 저장하는 시간을 `L`이라고 하자.
  - combinational cost `G`의 Nonpipelined version  
  ![nonpipelined_cost][def9]  
    - `Cost` = `G` + `L`
  - `k`-stage Pipelined version  
  ![pipelined_cost][def10]  
    - `Cost`<sub>`k-stage`</sub> = `G` + `Lk`  
    - Latch는 hardware cost를 증가시킨다.

<br>

### 3. Pipelined Operation
- Dividing Into Stages  
![pipelined_operation_stages][def11]  
  - 올바른 Partitioning일까? Ideal에 가까워 보이지는 않는다.  

- Instruction Pipeline Throughput  
![instruction_pipeline_throughput][def12]  

- Enabling Pipelined Processing: Pipeline Registers  
![pipeline_registers][def13]  

<br>

- Illustrating Pipeline Operation: Operation View  
![pipeline_operation_view][def14]  

- Illustrating Pipeline Operation: Resource View  
![pipeline_resource_view][def15]  

<br>

- Control Points in a Pipeline  
![control_points_in_pipeline][def16]

- Control Signals in a Pipeline
  - 주어진 명령어에 대해,
    - 같은 control signals를 single-cycle처럼, 하지만
    - control signals는 다른 cycles에서 필요로 한다. (각 stage마다 다름)
    - Option 1 : 같은 logic을 single-cycle처럼 사용하여 한번만 decode하고, 소비될 때까지 signals를 buffer한다.  
    ![pipeline_control_signals_option1][def17]  
    - Option 2 : pipeline을 내려가며 관련있는 "명령어 word/field"를 carry하고, 각 or 이전 stage 내에서 locally decode한다.  

- Pipelined Control Signals  
![pipelined_control_signals][def18]  

<br>

### 4. Pipeline Design  
- TODO  

<br>
<br>
<br>
<br>
<details>
<summary>주의사항</summary>
<div markdown="1">  

이 포스팅은 강원대학교 송원준 교수님의 컴퓨터구조 수업을 들으며 내용을 정리 한 것입니다.  
수업 내용에 대한 저작권은 교수님께 있으니,  
다른 곳으로의 무분별한 내용 복사를 자제해 주세요.  

</div>
</details>

[def]: https://i.imgur.com/aabd7ky.png
[def2]: https://i.imgur.com/6dRhKI1.png
[def3]: https://i.imgur.com/Cexic7e.png
[def4]: https://i.imgur.com/jzrsn6q.png
[def5]: https://i.imgur.com/7IsIe66.png
[def6]: https://i.imgur.com/V8ouiq2.png
[def7]: https://i.imgur.com/XcKssg9.png
[def8]: https://i.imgur.com/b3U48Tl.png
[def9]: https://i.imgur.com/JmPkECO.png
[def10]: https://i.imgur.com/VTIpRhr.png
[def11]: https://i.imgur.com/zybYZVs.png
[def12]: https://i.imgur.com/fA84L2E.png
[def13]: https://i.imgur.com/8Nm8ZoM.png
[def14]: https://i.imgur.com/pnRiwo1.png
[def15]: https://i.imgur.com/nCSLhPk.png
[def16]: https://i.imgur.com/nN9b0Ww.png
[def17]: https://i.imgur.com/Lsie6a8.png
[def18]: https://i.imgur.com/nyBttUd.png