---
layout: post
title: "[컴퓨터네트워크] 2주차 - Introduction to the network layer"
excerpt: "Introduction to the network layer, What's inside a router"

tags:
  - [컴퓨터네트워크]

toc: true

date: 2025-09-08
last_modified_at: 2025-09-11
---
## Introduction to the network layer
### 1. Introduction to the network layer
- 네트워크 계층의 역할
  - Segment를 Sender -> Receiver로 전달
    - Sender : segment를 데이터그램(datagram)으로 캡슐화하여 링크 계층(link layer)에 전달
    - Receiver : segment를 전송 계층(transport layer)에 전달

- 네트워크 계층은 모든 인터넷 기기(호스트, 라우터 등)에 존재  

- Routers
  - 통과하는 모든 IP datagram 내 헤더 필드를 검사
  - Datagram을 input 포트에서 output 포트로 움직임으로서 end-to-end path를 따라 datagram을 전달  
  - 두 가지 key functions
    - Forwarding : 패킷을 라우터의 input 링크에서 적절한 output 링크로 move
    - Routing : source -> destination으로 가기 위해 패킷이 취해야 할 경로를 결정
      - Routing algorithm

<br>

- Data Plane & Control Plane - 네트워크 레이어의 두 subsets
  - Data Plane (subset 1)
    - Local, per-router function
    - 어떻게 forwarding 할 지를 결정

  - Control Plane (subset 2)
    - Network-wide logic
    - 어떻게 routing 할 지를 결정
    - 두 가지 control-plane approaches
      - Traditional routing algorithms : 라우터 자체에 구현  
      ![traditional_routing][def]  
      - Software-defined networking (SDN) : 컨트롤러라고 불리는 원격 서버에 구현  
      ![sdn][def2]  

      <br>

- 네트워크 서비스 모델
  - Q. Datagram을 전달하는 "채널"은 어떤 서비스 모델을 제공할 수 있을까?
    - 각 datagrams에 대한 서비스 Example
      - Guaranteed delivery
      - Guaranteed delivery with less than 40ms delay
    - Datagram flow를 위한 서비스 Example
      - In-order datagram delivery
      - Guaranteed minimum bandwidth to flow
      - Inter-packet spacing 변동에 대한 제한  

      <br>

  - 그러나 실제 인터넷은 "Best effort" 서비스 모델을 제공한다.
    - **No** guarantees on
      - (1) 목적지로의 성공적인 datagram 전달
      - (2) 전달 시간과 순서
      - (3) end-end flow에 대한 최소 대역폭

    <br>

|Network Architecture|Service Model|Bandwidth|Loss|Order|Timing|
|---|---|---|---|---|---|
|Internet|Best-effort|None|No|No|No|
|ATM|Constant Bit Rate|Constant rate|Yes|Yes|Yes|
|ATM|Available Bit Rate|Guaranteed min|No|Yes|No|
|Internet|Intserv Guaranteed<br>(RFC 1633)|Yes|Yes|Yes|Yes|
|Internet|Diffserv<br>(RFC 2475)|Possible|Possibly|Possibly|No|

<br>

- Best-effort 서비스의 Reflections
  - 메커니즘의 단순함이 인터넷을 널리 사용되게 만들었다.
  - Bandwidth를 충분히 프로비저닝하면, 대부분의 상황에서 충분히 좋은 real-time 서비스를 제공할 수 있다.
  - Datacenter나 CDN처럼 복제/분산된 애플리케이션 계층 서비스는 클라이언트 네트워크 가까이에서 여러 지역에 서비스를 제공하게 해준다.
  - "Elastic" 서비스는 Congestion control을 통해 네트워크 상태에 적응한다.  
  등 등..

### 2. What's inside a router
- High-level abstraction  
![router_abstraction][def3]  

<br>

- Input port functions  
![input_port][def4]  
  - Decentralized switching
    - 헤더 필드 값을 사용하여, input port 메모리의 포워딩 테이블을 사용해 output port를 결정
    - 목적 : 'line speed'에 맞춰 input port 프로세싱을 수행
    - **Input port queuing** : Datagram이 switch fabric에 forwarding rate보다 빠르게 도착할 때
    - **Destination-based forwarding** : 오직 목적지 IP 주소에 기반하여 forward (traditional)
    - **Generalized forwarding** : Any set of header fields에 기반하여 forward  

- Destination-based forwarding  
![destination_based_forwarding][def5] 
  - Entry가 늘어나면 늘어날 수록 lookup 시간이 길어지며, 메모리 문제가 발생할 수 있다.  

- Longest prefix matching
  - 주어진 목적지 주소에 대해 forwarding table entry를 탐색할 때, 해당 주소와 일치하는 가장 긴 address prefix를 사용한다.  
  ![longest_prefix_matching][def6]  
    - 첫 번째 example은 Link 0
    - 두 번째 example은 Link 1

  - 이 작업은 TCAM(Ternary Content Addressable Memory)이라는 특수 메모리에서 수행된다.
  - Content를 넣으면 one clock cycle 안에 lookup이 가능하다. (table size에 무관하게)  
  ![tcam][def7]  

<br>

- Switching fabrics
  - 패킷을 input port에서 적절한 output link로 이동
  - Switching rate : 패킷이 input -> output으로 이동할 수 있는 속도
    - 주로 input/output line rate의 두 배로 측정된다.
    - `N` inputs : line rate의 `N`배를 요구  
    ![switching_fabrics][def8]  
  - 세 가지 주요 유형  
  ![switching_fabrics_types][def9]  
    - (1) Memory  
    ![memory_switching][def10]  
      - 패킷이 시스템 메모리에 복사
      - 속도가 memory bandwidth에 의해 제한됨 
    - (2) Bus  
    ![bus_switching][def11]  
      - 패킷이 공유된 버스를 통해 이동
      - Bus contention 발생 - 독점 사용, Bus bandwidth에 의해 제한됨  
    - (3) Interconnection network  
    ![interconnection_network_switching][def12]  
      - 멀티프로세서에서 프로세서들을 연결하는 데 사용되는 것과 동일한 기술
      - a.k.a. Crossbar, Clos networks
      - Multistage switch : n x n switch를 여러 개 연결하여 더 큰 스위치를 만듦
      - Exploring parallelism
        - 긴 패킷을 고정 길이의 cell로 분할
        - 잘라낸 cell들을 스위치 내부에서 병렬로 전송 & 재조립
      - 더 나아가, 여러 개의 switching "planes"를 병렬로 사용  
      ![multiple_switching_planes][def13]  
        - 병렬화를 통해 속도 향상
        - Cisco CRS router  

        <br>

- Input port queuing
  - output port contention  
  ![output_port_contention][def14]  
    - 오직 하나의 빨간색 datagram만이 전송될 수 있음. 아래 쪽의 빨간색 패킷은 **blocked**.  
  - one packet time later  
  ![one_packet_time_later][def15]  
    - 초록색 패킷이 HOL blocking을 경험.
  
  - 만약 switch fabric이 input ports보다 느리다면, input queue에서 queuing이 발생할 수 있다.

- Output port queuing  
![output_port_queuing][def16]
  - Buffering
    - Datagram이 link transmission rate보다 빠르게 fabric으로부터 도착할 때  
    `output line speed` < `arrival rate`  
    - buffer가 부족해지면, congestion으로 인해 datagram이 drop(lost)될 수 있음
  - Scheduling discipline
    - Queue에서 어떤 datagram을 전송할 지 선택을 결정

<br>

- How much buffering?
  - RFC 3439 rule of thumb
    - 평균적인 buffering은 `RTT` x `C`(link capacity)  
      - e..g, `C` = `10`Gbps, `RTT` = `250`ms -> `2.5`Gbit buffer

  - More recent recommendation : with `N` flows, `RTT` x `C` / `sqrt(N)`  
  
  - 그러나 과도한 buffering은 delays를 증가시킨다. -> Long RTTs  

  <br>

- Buffer management  
![buffer_management][def17]  
  - Drop
    - 버퍼가 가득 찼을 때, add/drop 할 패킷 선택
    - Tail drop : 가장 최근에 도착한 패킷을 drop
    - Priority : 우선순위에 기반하여 drop/remove  
  - Marking
    - congestion이 발생했음을 알리기 위해 표시할 패킷 선택 (ECN, RED)  

    <br>

- Packet scheduling  
  - 다음으로 link에 보낼 패킷을 결정
    - First Come, First Serve (FCFS)  
    - Priority scheduling  
    ![priority_scheduling][def18]  
      - 우선순위가 높은 패킷이 먼저 전송됨
      - 낮은 우선순위 패킷이 무한정 대기하는 현상 발생 가능 (starvation)
    - Round Robin  
    ![round_robin_scheduling][def19]  
      - 각 큐에서 하나씩 패킷을 선택하여 전송
      - 큐의 길이가 다를 때, 긴 큐가 불리
    - Weighted fair queuing  
    ![weighted_fair_queuing][def20]  
      - Generalized Round Robin
      - 각 큐에 가중치를 부여하여, 가중치에 비례하여 패킷을 전송

<br>
<br>
<br>
<br>
<details>
<summary>주의사항</summary>
<div markdown="1">

이 포스팅은 강원대학교 김도형 교수님의 컴퓨터네트워크 수업을 들으며 내용을 정리 한 것입니다.  
수업 내용에 대한 저작권은 교수님께 있으니,  
다른 곳으로의 무분별한 내용 복사를 자제해 주세요.

</div>
</details>

[def]: https://i.imgur.com/Y9i7Bvy.png
[def2]: https://i.imgur.com/SlJvyqY.png
[def3]: https://i.imgur.com/Io3Tvmc.png
[def4]: https://i.imgur.com/ixUchg2.png
[def5]: https://i.imgur.com/5y13n6D.png
[def6]: https://i.imgur.com/LfwOjXg.png
[def7]: https://i.imgur.com/piMh2KM.png
[def8]: https://i.imgur.com/iWOv3co.png
[def9]: https://i.imgur.com/ChAFxWM.png
[def10]: https://i.imgur.com/Bj6lXPm.png
[def11]: https://i.imgur.com/wbPW2Er.png
[def12]: https://i.imgur.com/eZ7tWq3.png
[def13]: https://i.imgur.com/cuNMDrt.png
[def14]: https://i.imgur.com/5hOXwCe.png
[def15]: https://i.imgur.com/Yb7pmaU.png
[def16]: https://i.imgur.com/B7ghNde.png
[def17]: https://i.imgur.com/lVayTyy.png
[def18]: https://i.imgur.com/NCdjITQ.png
[def19]: https://i.imgur.com/okgRrWF.png
[def20]: https://i.imgur.com/c9ZgN0e.png